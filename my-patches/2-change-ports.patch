commit 2c2d0fb4774d37ec8371367049bdb75038fd2039
Author: Xun Chen <xunchen369@gmail.com>
Date:   Wed Apr 9 17:34:12 2025 +0800

    change ports and remove nginx

diff --git a/docker/docker-compose.yaml b/docker/docker-compose.yaml
index b244f7509..29b4d5e4a 100644
--- a/docker/docker-compose.yaml
+++ b/docker/docker-compose.yaml
@@ -489,6 +489,8 @@ services:
       SENTRY_PROFILES_SAMPLE_RATE: ${API_SENTRY_PROFILES_SAMPLE_RATE:-1.0}
       PLUGIN_MAX_PACKAGE_SIZE: ${PLUGIN_MAX_PACKAGE_SIZE:-52428800}
       INNER_API_KEY_FOR_PLUGIN: ${PLUGIN_DIFY_INNER_API_KEY:-QaHbTe77CtuXmsfyhR7+vRjI/+XbV1AaFy691iy+kGDv2Jvy0/eAh8Y1}
+    ports:
+      - '${API_PORT:-5001}:5001'
     depends_on:
       db:
         condition: service_healthy
@@ -536,6 +538,8 @@ services:
   web:
     image: langgenius/dify-web:1.2.0
     restart: always
+    ports:
+      - '${WEB_PORT:-3000}:3000'
     environment:
       CONSOLE_API_URL: ${CONSOLE_API_URL:-}
       APP_API_URL: ${APP_API_URL:-}
@@ -664,7 +668,8 @@ services:
       TENCENT_COS_SECRET_ID: ${PLUGIN_TENCENT_COS_SECRET_ID:-}
       TENCENT_COS_REGION: ${PLUGIN_TENCENT_COS_REGION:-}
     ports:
-      - '${EXPOSE_PLUGIN_DEBUGGING_PORT:-5003}:${PLUGIN_DEBUGGING_PORT:-5003}'
+      - '${PLUGIN_PORT:-4442}:${PLUGIN_DAEMON_PORT:-4442}'
+      - '${EXPOSE_PLUGIN_DEBUGGING_PORT:-4443}:${PLUGIN_DEBUGGING_PORT:-4443}'
     volumes:
       - ./volumes/plugin_daemon:/app/storage
     depends_on:
@@ -723,6 +728,8 @@ services:
   # used for reverse proxying the API service and Web service.
   nginx:
     image: nginx:latest
+    profiles:
+      - nginx
     restart: always
     volumes:
       - ./nginx/nginx.conf.template:/etc/nginx/nginx.conf.template
diff --git a/vs-nginx.example.conf b/vs-nginx.example.conf
new file mode 100644
index 000000000..9cc546584
--- /dev/null
+++ b/vs-nginx.example.conf
@@ -0,0 +1,91 @@
+# Common proxy settings
+proxy_http_version 1.1;
+proxy_set_header Host $host;
+proxy_set_header X-Real-IP $remote_addr;
+proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
+proxy_set_header X-Forwarded-Proto $scheme;
+proxy_set_header Upgrade $http_upgrade;
+proxy_set_header Connection "upgrade";
+
+# Define upstream servers
+upstream dify_api {
+    server localhost:4441;
+}
+
+upstream dify_web {
+    server localhost:4440;
+}
+
+upstream dify_plugin {
+    server localhost:4442;
+}
+
+# Configuration for dify.vsource.local (Web frontend)
+server {
+    listen 443 ssl;
+    listen [::]:443 ssl;
+    include snippets/ssl-cert.conf;
+    include snippets/ssl-params.conf;
+    include snippets/ssl-headers.conf;
+    include /etc/nginx/default.d/*.conf;
+    
+    server_name dify.vsource.local;
+    
+    error_page 502 /404.html;
+    
+    location = /404.html {
+        root /root/dify/web/public;
+    }
+    
+    # API request settings
+    location ~ ^/(console/api|api|v1|files) {
+        proxy_pass http://dify_api;
+        client_max_body_size 60M;
+        proxy_connect_timeout 600;
+        proxy_send_timeout 600;
+        proxy_read_timeout 600;
+        send_timeout 600;
+    }
+    
+    # For plugin endpoints
+    location /e/ {
+        proxy_pass http://dify_plugin;
+        proxy_set_header Dify-Hook-Url $scheme://$host$request_uri;
+    }
+    
+    # For all other web UI requests
+    location / {
+        proxy_pass http://dify_web;
+    }
+}
+
+# Configuration for dify-api.vsource.local (API backend)
+server {
+    listen 443 ssl;
+    listen [::]:443 ssl;
+    include snippets/ssl-cert.conf;
+    include snippets/ssl-params.conf;
+    include snippets/ssl-headers.conf;
+    include /etc/nginx/default.d/*.conf;
+    
+    server_name dify-api.vsource.local;
+    
+    # Increase timeouts and body size
+    client_max_body_size 60M;
+    proxy_connect_timeout 600;
+    proxy_send_timeout 600;
+    proxy_read_timeout 600;
+    send_timeout 600;
+    
+    location / {
+        proxy_pass http://dify_api;
+    }
+}
+
+# HTTP to HTTPS redirects
+server {
+    listen 80;
+    listen [::]:80;
+    server_name dify.vsource.local dify-api.vsource.local;
+    return 301 https://$host$request_uri;
+}
\ No newline at end of file
